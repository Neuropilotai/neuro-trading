name: NeuroInnovate Enterprise v19.0 - Autonomous Railway Deploy

# Trigger deployment on push to main branch
# Only when files in backend or ml-service change
on:
  push:
    branches:
      - main
    paths:
      - 'inventory-enterprise/backend/**'
      - 'inventory-enterprise/ml-service/**'
      - '.github/workflows/autonomous_railway_deploy.yml'
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.11'

jobs:
  # =====================================================
  # JOB 1: Backend Build & Test
  # =====================================================
  backend-build:
    name: Backend - Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: inventory-enterprise/backend

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: inventory-enterprise/backend/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Run Linter
        run: npm run lint || echo "‚ö†Ô∏è Linting issues found (non-blocking)"
        continue-on-error: true

      - name: Run Tests
        run: npm test || echo "‚ö†Ô∏è Tests failed (non-blocking for now)"
        continue-on-error: true

      - name: Verify Server Entry Point
        run: |
          if [ ! -f "server.js" ]; then
            echo "‚ùå server.js not found!"
            exit 1
          fi
          echo "‚úÖ server.js exists"

      - name: Verify Procfile
        run: |
          if [ ! -f "Procfile" ]; then
            echo "‚ùå Procfile not found!"
            exit 1
          fi
          echo "‚úÖ Procfile exists"
          cat Procfile

      - name: Check 0.0.0.0 Binding
        run: |
          if grep -q "listen.*0\.0\.0\.0" server.js; then
            echo "‚úÖ Server binds to 0.0.0.0 (Railway-compatible)"
          else
            echo "‚ö†Ô∏è Warning: Server may not bind to 0.0.0.0"
          fi

  # =====================================================
  # JOB 2: ML Service Build & Test
  # =====================================================
  ml-service-build:
    name: ML Service - Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: inventory-enterprise/ml-service

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: inventory-enterprise/ml-service/requirements.txt

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Verify Main Entry Point
        run: |
          if [ ! -f "main.py" ]; then
            echo "‚ùå main.py not found!"
            exit 1
          fi
          echo "‚úÖ main.py exists"

      - name: Verify Procfile
        run: |
          if [ ! -f "Procfile" ]; then
            echo "‚ùå Procfile not found!"
            exit 1
          fi
          echo "‚úÖ Procfile exists"
          cat Procfile

      - name: Check FastAPI App Definition
        run: |
          if grep -q "app = FastAPI" main.py; then
            echo "‚úÖ FastAPI app defined"
          else
            echo "‚ùå FastAPI app not found in main.py"
            exit 1
          fi

      - name: Lint Python Code
        run: |
          pip install pylint || true
          pylint main.py --disable=all --enable=E || echo "‚ö†Ô∏è Python linting issues (non-blocking)"
        continue-on-error: true

  # =====================================================
  # JOB 3: Railway Deployment Check (Optional)
  # =====================================================
  railway-deploy-check:
    name: Railway Deployment Check
    runs-on: ubuntu-latest
    needs: [backend-build, ml-service-build]
    if: success()

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Verify Railway Config
        run: |
          echo "üîç Checking Railway configuration..."

          # Check root railway.json
          if [ -f "railway.json" ]; then
            echo "‚úÖ Root railway.json found"
            cat railway.json
          else
            echo "‚ö†Ô∏è Root railway.json not found (optional)"
          fi

          # Check backend Procfile
          if [ -f "inventory-enterprise/backend/Procfile" ]; then
            echo "‚úÖ Backend Procfile found"
          else
            echo "‚ùå Backend Procfile missing"
            exit 1
          fi

          # Check ML service Procfile
          if [ -f "inventory-enterprise/ml-service/Procfile" ]; then
            echo "‚úÖ ML Service Procfile found"
          else
            echo "‚ùå ML Service Procfile missing"
            exit 1
          fi

      - name: Deployment Summary
        run: |
          echo "=================================================="
          echo "  NeuroNexus v19.0 Railway Deployment Ready"
          echo "=================================================="
          echo ""
          echo "‚úÖ Backend build passed"
          echo "‚úÖ ML service build passed"
          echo "‚úÖ Railway config verified"
          echo ""
          echo "üöÄ Ready for Railway deployment!"
          echo ""
          echo "Next steps:"
          echo "1. Railway will auto-deploy from main branch (if enabled)"
          echo "2. OR manually deploy via Railway Dashboard"
          echo "3. Run smoke tests after deployment"
          echo ""
          echo "üìö Documentation:"
          echo "- V19_DEPLOYMENT_RUNBOOK.md"
          echo "- AUTONOMOUS_RAILWAY_DEPLOYMENT_GUIDE.md"
          echo "=================================================="

  # =====================================================
  # JOB 4: Post-Deploy Health Check (Optional)
  # This job only runs if RAILWAY_BACKEND_URL is set in secrets
  # =====================================================
  post-deploy-check:
    name: Post-Deploy Health Check
    runs-on: ubuntu-latest
    needs: [railway-deploy-check]
    if: success() && vars.RAILWAY_BACKEND_URL != ''

    steps:
      - name: Wait for Deployment
        run: |
          echo "‚è≥ Waiting 60 seconds for Railway deployment to complete..."
          sleep 60

      - name: Backend Health Check
        run: |
          echo "üß™ Testing backend health endpoint..."
          curl -f -s "${{ vars.RAILWAY_BACKEND_URL }}/api/health" | jq '.'
        continue-on-error: true

      - name: ML Service Health Check
        run: |
          echo "üß™ Testing ML service health endpoint..."
          curl -f -s "${{ vars.RAILWAY_ML_URL }}/status" | jq '.'
        continue-on-error: true
        if: vars.RAILWAY_ML_URL != ''

      - name: Scheduler Status Check
        run: |
          echo "üß™ Checking scheduler status..."
          curl -s "${{ vars.RAILWAY_BACKEND_URL }}/api/health" | jq '.scheduler'
        continue-on-error: true

# =====================================================
# ALTERNATIVE: Railway CLI Deployment (Commented Out)
# =====================================================
# Uncomment this job to deploy via Railway CLI instead of auto-deploy
#
#  railway-cli-deploy:
#    name: Deploy via Railway CLI
#    runs-on: ubuntu-latest
#    needs: [backend-build, ml-service-build]
#    if: success()
#
#    steps:
#      - name: Checkout Code
#        uses: actions/checkout@v4
#
#      - name: Install Railway CLI
#        run: |
#          curl -fsSL https://railway.app/install.sh | sh
#          railway --version
#
#      - name: Deploy Backend Service
#        run: |
#          cd inventory-enterprise/backend
#          railway link --project ${{ secrets.RAILWAY_PROJECT_ID }} --service backend
#          railway up --service backend
#        env:
#          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
#
#      - name: Deploy ML Service
#        run: |
#          cd inventory-enterprise/ml-service
#          railway link --project ${{ secrets.RAILWAY_PROJECT_ID }} --service ml-service
#          railway up --service ml-service
#        env:
#          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
#
#      - name: Get Deployment URLs
#        run: |
#          railway status --service backend
#          railway status --service ml-service
#        env:
#          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

# =====================================================
# Required GitHub Secrets (for Railway CLI deployment)
# =====================================================
# Add these to your repository: Settings ‚Üí Secrets ‚Üí Actions
#
# RAILWAY_TOKEN:          Railway API token (from railway.app/account/tokens)
# RAILWAY_PROJECT_ID:     Railway project ID (from project settings)
#
# Optional Variables (for health checks):
# RAILWAY_BACKEND_URL:    Backend public URL (e.g., https://backend-production-abc.up.railway.app)
# RAILWAY_ML_URL:         ML service public URL
# =====================================================
